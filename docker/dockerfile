FROM rlsys/rocm-6.3.4-patch:rocm6.3.4-numa-patch_ubuntu-22.04

# Set working directory to verl directory
WORKDIR /workspace/verl

# Copy the verl source code and README from the parent directory
COPY verl/ .
COPY README.md .

# Install Python packages
RUN pip install accelerate \
    codetiming \
    datasets \
    dill \
    hydra-core \
    liger-kernel \
    numpy \
    pandas \
    peft \
    "pyarrow>=15.0.0" \
    pylatexenc \
    "ray[data,train,tune,serve]>=2.45.0" \
    torchdata \
    transformers \
    wandb \
    orjson \
    pybind11

# Install verl package in editable mode
RUN pip install -e . --no-deps

# Downgrade ray to specific version
RUN pip install ray==2.44.1

# Modify the vllm triton attention file
RUN sed -i 's/return \[32, 64, 96, 128, 160, 192, 224, 256\]/return [32, 64, 80, 96, 128, 160, 192, 224, 256]/' \
    /usr/local/lib/python3.12/dist-packages/vllm-0.8.5.dev0+rocm634-py3.12-linux-x86_64.egg/vllm/v1/attention/backends/triton_attn.py

# Set default command
CMD ["/bin/bash"]